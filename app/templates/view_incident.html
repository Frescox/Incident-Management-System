<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detalle de Incidencia - Sistema de Incidencias</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='css/style.css') }}" />
  </head>
  <body>
    <div class="incident-container">
      <div class="user-info">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h2>{{ nombre }} {{ apellido }}</h2>
            <p class="mb-0 text-muted">Correo: {{ correo }}</p>
          </div>
          <div>
            <a
              href="{{ url_for('user.dashboard') }}"
              class="btn btn-outline-secondary me-2">
              <i class="bi bi-arrow-left"></i> Volver
            </a>
            <a href="{{ url_for('auth.logout') }}" class="btn btn-danger">
              <i class="bi bi-box-arrow-right"></i> Cerrar sesión
            </a>
          </div>
        </div>
      </div>

      <div class="incident-header">
        <h3 class="section-title">
          Incidencia #{{ incidencia.id }}: {{ incidencia.titulo }}
        </h3>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <span
            class="badge {% if incidencia.estado_nombre == 'nuevo' %}badge-new {% elif incidencia.estado_nombre == 'en_progreso' %}badge-in-progress {% elif incidencia.estado_nombre == 'resuelto' %}badge-resolved {% else %}badge-closed{% endif %}">
            {{ incidencia.estado_nombre|replace('_', ' ')|title }}
          </span>
          <small class="text-muted"
            >Creada: {{ incidencia.fecha_creacion.strftime('%d/%m/%Y %H:%M')
            }}</small
          >
        </div>
      </div>

      <div class="incident-details">
        <div class="row mb-3">
          <div class="col-md-6">
            <p class="detail-label">Categoría</p>
            <p>{{ incidencia.categoria_nombre }}</p>
          </div>
          <div class="col-md-6">
            <p class="detail-label">Prioridad</p>
            <p>{{ incidencia.prioridad_nombre|capitalize }}</p>
          </div>
        </div>

        <div class="mb-3">
          <p class="detail-label">Descripción</p>
          <p>{{ incidencia.descripcion }}</p>
        </div>

        <div class="row">
          <div class="col-md-6">
            <p class="detail-label">Última Actualización</p>
            <p>
              {{ incidencia.fecha_ultima_actualizacion.strftime('%d/%m/%Y
              %H:%M') }}
            </p>
          </div>
          {% if incidencia.fecha_resolucion %}
          <div class="col-md-6">
            <p class="detail-label">Fecha Resolución</p>
            <p>{{ incidencia.fecha_resolucion.strftime('%d/%m/%Y %H:%M') }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="comments-section">
        <h5 class="section-title">Comentarios</h5>

        {% if not incidencia.comentarios %}
        <div class="alert alert-info">
          No hay comentarios para esta incidencia.
        </div>
        {% else %} {% for comentario in incidencia.comentarios %}
        <div class="comment">
          <div class="d-flex justify-content-between">
            <strong
              >{{ comentario.usuario.nombre }} {{ comentario.usuario.apellido
              }}</strong
            >
            <small class="text-muted"
              >{{ comentario.created_at.strftime('%d/%m/%Y %H:%M') }}</small
            >
          </div>
          <p>{{ comentario.contenido }}</p>
        </div>
        {% endfor %} {% endif %}

        <form
          method="POST"
          action="{{ url_for('user.add_comment', incident_id=incidencia.id) }}"
          class="mt-4">
          <div class="mb-3">
            <label for="comment" class="form-label">Agregar Comentario</label>
            <textarea
              class="form-control"
              id="comment"
              name="comment"
              rows="3"
              required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">
            Enviar Comentario
          </button>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
